<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validação de E-mail - COPSOQ II</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding-top: 50px;
        }
        .header {
            background-color: #0d6efd;
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
        }
        .container {
            max-width: 600px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .btn-primary {
            background-color: #0d6efd;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
        }
        .form-control:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .validation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
        }
        .verification-code {
            letter-spacing: 0.5em;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }
        .lgpd-notice {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .lgpd-notice h5 {
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1>Questionário COPSOQ II</h1>
            <p class="lead">Validação de E-mail</p>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Acesso ao Questionário</h5>
            </div>
            <div class="card-body">
                <div class="lgpd-notice">
                    <h5>Aviso de Privacidade - LGPD</h5>
                    <p>De acordo com a Lei Geral de Proteção de Dados (LGPD), informamos que:</p>
                    <ul>
                        <li>Seus dados serão utilizados exclusivamente para fins de avaliação de fatores psicossociais no ambiente de trabalho;</li>
                        <li>As informações coletadas serão tratadas de forma anônima e agregada;</li>
                        <li>Os resultados serão utilizados para melhorias no ambiente organizacional;</li>
                        <li>Você tem o direito de solicitar acesso, correção ou exclusão dos seus dados a qualquer momento.</li>
                    </ul>
                    <p>Ao prosseguir com a validação de e-mail, você concorda com os termos acima.</p>
                </div>

                <div id="email-form">
                    <p class="mb-4">Para acessar o questionário COPSOQ II, por favor, informe seu e-mail corporativo. Um código de verificação será enviado para validação.</p>
                    
                    <div class="mb-3">
                        <label for="email" class="form-label">E-mail corporativo:</label>
                        <input type="email" class="form-control" id="email" placeholder="seu.nome@empresa.com.br" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="empresa" class="form-label">Empresa:</label>
                        <input type="text" class="form-control" id="empresa" placeholder="Nome da sua empresa" required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="send-code-btn">Enviar Código de Verificação</button>
                    </div>
                </div>

                <div id="verification-form" style="display: none;">
                    <p class="mb-4">Um código de verificação foi enviado para o seu e-mail. Por favor, insira o código abaixo para acessar o questionário.</p>
                    
                    <div class="verification-code" id="verification-code">XXXXXX</div>
                    
                    <div class="mb-3">
                        <label for="code" class="form-label">Código de verificação:</label>
                        <input type="text" class="form-control" id="code" placeholder="Digite o código recebido" required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" id="verify-code-btn">Verificar Código</button>
                        <button type="button" class="btn btn-outline-secondary" id="resend-code-btn">Reenviar Código</button>
                    </div>
                </div>

                <div id="success-message" style="display: none;">
                    <div class="alert alert-success" role="alert">
                        <h4 class="alert-heading">E-mail verificado com sucesso!</h4>
                        <p>Você será redirecionado para o questionário em alguns segundos...</p>
                    </div>
                </div>

                <div id="error-message" style="display: none;">
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">Erro na verificação</h4>
                        <p id="error-text">O código informado não é válido. Por favor, tente novamente.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-light py-4 mt-5">
        <div class="container text-center">
            <p>Questionário de Avaliação de Fatores Psicossociais no Trabalho - COPSOQ II (Versão Média)</p>
            <p><small>Em conformidade com a NR-17 (Ergonomia) e NR-1</small></p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="js/firebase_config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar Firebase
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                const database = firebase.database();
            }

            const emailForm = document.getElementById('email-form');
            const verificationForm = document.getElementById('verification-form');
            const successMessage = document.getElementById('success-message');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const verificationCodeDisplay = document.getElementById('verification-code');
            
            const sendCodeBtn = document.getElementById('send-code-btn');
            const verifyCodeBtn = document.getElementById('verify-code-btn');
            const resendCodeBtn = document.getElementById('resend-code-btn');
            
            let verificationCode = '';
            let userEmail = '';
            let userEmpresa = '';
            
            // Função para gerar código de verificação aleatório
            function generateVerificationCode() {
                const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                let code = '';
                for (let i = 0; i < 6; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return code;
            }
            
            // Função para simular envio de e-mail (em ambiente real, seria feito via backend)
            function sendVerificationEmail(email, code) {
                console.log(`Código de verificação ${code} enviado para ${email}`);
                // Em um ambiente real, aqui seria feita uma chamada para API de envio de e-mail
                // Nesta simulação, apenas exibimos o código na tela
                verificationCodeDisplay.textContent = code;
            }
            
            // Evento para enviar código de verificação
            sendCodeBtn.addEventListener('click', function() {
                const emailInput = document.getElementById('email');
                const empresaInput = document.getElementById('empresa');
                
                userEmail = emailInput.value.trim();
                userEmpresa = empresaInput.value.trim();
                
                if (!userEmail) {
                    errorText.textContent = 'Por favor, informe um e-mail válido.';
                    errorMessage.style.display = 'block';
                    return;
                }
                
                if (!userEmpresa) {
                    errorText.textContent = 'Por favor, informe o nome da empresa.';
                    errorMessage.style.display = 'block';
                    return;
                }
                
                // Validar formato do e-mail
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(userEmail)) {
                    errorText.textContent = 'Por favor, informe um e-mail válido.';
                    errorMessage.style.display = 'block';
                    return;
                }
                
                // Gerar e enviar código de verificação
                verificationCode = generateVerificationCode();
                sendVerificationEmail(userEmail, verificationCode);
                
                // Mostrar formulário de verificação
                emailForm.style.display = 'none';
                errorMessage.style.display = 'none';
                verificationForm.style.display = 'block';
            });
            
            // Evento para verificar código
            verifyCodeBtn.addEventListener('click', function() {
                const codeInput = document.getElementById('code');
                const userCode = codeInput.value.trim();
                
                if (userCode === verificationCode) {
                    // Código válido
                    verificationForm.style.display = 'none';
                    errorMessage.style.display = 'none';
                    successMessage.style.display = 'block';
                    
                    // Salvar informações de acesso no localStorage
                    localStorage.setItem('copsoq_email_verified', 'true');
                    localStorage.setItem('copsoq_user_email', userEmail);
                    localStorage.setItem('copsoq_user_empresa', userEmpresa);
                    
                    // Redirecionar para o questionário após 2 segundos
                    setTimeout(function() {
                        window.location.href = 'questionario_medio.html';
                    }, 2000);
                } else {
                    // Código inválido
                    errorText.textContent = 'O código informado não é válido. Por favor, tente novamente.';
                    errorMessage.style.display = 'block';
                }
            });
            
            // Evento para reenviar código
            resendCodeBtn.addEventListener('click', function() {
                // Gerar novo código e reenviar
                verificationCode = generateVerificationCode();
                sendVerificationEmail(userEmail, verificationCode);
                
                // Feedback para o usuário
                alert('Um novo código de verificação foi enviado para o seu e-mail.');
            });
        });
    </script>
</body>
</html>
